(()=>{"use strict";var e={1167(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getFromLocalStorage=t.saveToLocalStorage=t.getSeasonFactors=t.saveSeasonFactors=t.updateFactors=t.getFactors=t.saveFactors=void 0;const o="submittedFactors";t.saveFactors=e=>{localStorage.setItem(o,JSON.stringify(e))},t.getFactors=()=>{const e=localStorage.getItem(o);return e?JSON.parse(e):[]},t.updateFactors=e=>{const o=(0,t.getFactors)(),r=[...o];e.forEach(e=>{o.some(t=>t.id===e.id)||r.push(e)}),(0,t.saveFactors)(r)},t.saveSeasonFactors=(e,t)=>new Promise(o=>{const r={season:e,alphas:t,lastUpdated:Date.now()};chrome.storage.local.set({[e]:r},()=>{o()})}),t.getSeasonFactors=e=>new Promise(t=>{chrome.storage.local.get([e],o=>{o[e]?t(o[e].alphas):t([])})}),t.saveToLocalStorage=(e,t)=>new Promise(o=>{chrome.storage.local.set({[e]:t},o)}),t.getFromLocalStorage=e=>new Promise(t=>{chrome.storage.local.get([e],o=>t(o[e]))})},7618(e,t,o){var r=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))(function(a,s){function n(e){try{i(r.next(e))}catch(e){s(e)}}function c(e){try{i(r.throw(e))}catch(e){s(e)}}function i(e){var t;e.done?a(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(n,c)}i((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const a=o(1167);console.log("WQB Alpha Manager Content Script Loaded");const s=e=>new Promise(t=>setTimeout(t,e)),n=e=>{if(e.code)return e.code;if(e.regular){if("string"==typeof e.regular)return e.regular;if(e.regular.code)return e.regular.code}return"无表达式"};chrome.runtime.onMessage.addListener((e,t,o)=>{if("fetch_and_save"===e.action){const t=e.startDate,c=e.endDate,i=e.season;return console.log(`[WQB Manager] 开始抓取: ${i} (${t} ~ ${c})`),r(void 0,void 0,void 0,function*(){let e=[],o=0,r=!0;const a=encodeURIComponent(`${t}T00:00:00-04:00`),i=encodeURIComponent(`${c}T23:59:59-04:00`);for(;r;){const t=`https://api.worldquantbrain.com/users/self/alphas?limit=100&offset=${o}&status!=UNSUBMITTED&type=REGULAR&dateCreated>=${a}&dateCreated<=${i}`;try{console.log(`[WQB Manager] Fetching offset ${o}...`),o>0&&(yield s(3e3));const a=yield fetch(t,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!a.ok){if(429===a.status)throw new Error("请求太快被限制了(429)，请等待几分钟后再试。");if(401===a.status||403===a.status)throw new Error("未登录或登录过期(401/403)。请在浏览器中重新登录 WQ 官网并刷新页面。");throw new Error(`HTTP error! status: ${a.status}`)}const c=yield a.json(),i=c.results||[],l=c.count||0;if(0===i.length){r=!1;break}const d=i.map(e=>{var t;return{id:e.id,code:n(e),dateCreated:e.dateCreated,author:"Me",region:(null===(t=e.settings)||void 0===t?void 0:t.region)||"UNKNOWN"}});e=e.concat(d),o+=100,o>=l&&(r=!1),e.length>2e4&&(console.warn("达到 20000 条限制，停止抓取"),r=!1)}catch(e){throw console.error("[WQB Manager] 抓取出错:",e),e}}return e}).then(e=>(console.log(`[WQB Manager] 抓取完成，共 ${e.length} 条`),(0,a.saveSeasonFactors)(i,e).then(()=>e.length))).then(e=>{o({msg:`成功下载 ${e} 个因子到 ${i}`})}).catch(e=>{o({msg:`抓取失败: ${e.message}`})}),!0}if("match_field"===e.action)return!0})}},t={};!function o(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,o),s.exports}(7618)})();
//# sourceMappingURL=content.bundle.js.map