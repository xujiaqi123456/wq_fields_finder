{"version":3,"file":"content.bundle.js","mappings":"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","sources":["webpack://wqb-alpha-manager/./src/utils/storage.ts","webpack://wqb-alpha-manager/./src/content/index.ts","webpack://wqb-alpha-manager/webpack/bootstrap","webpack://wqb-alpha-manager/webpack/startup"],"sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.getFromLocalStorage = exports.saveToLocalStorage = exports.getSeasonFactors = exports.saveSeasonFactors = exports.updateFactors = exports.getFactors = exports.saveFactors = void 0;\r\nconst STORAGE_KEY = 'submittedFactors';\r\n/**\r\n * Save submitted factors to local storage.\r\n * @param factors - The factors data to save.\r\n */\r\nconst saveFactors = (factors) => {\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(factors));\r\n};\r\nexports.saveFactors = saveFactors;\r\n/**\r\n * Retrieve submitted factors from local storage.\r\n * @returns The factors data retrieved from local storage.\r\n */\r\nconst getFactors = () => {\r\n    const factors = localStorage.getItem(STORAGE_KEY);\r\n    return factors ? JSON.parse(factors) : [];\r\n};\r\nexports.getFactors = getFactors;\r\n/**\r\n * Update local storage with new factors if they are not already present.\r\n * @param newFactors - The new factors data to check and potentially save.\r\n */\r\nconst updateFactors = (newFactors) => {\r\n    const existingFactors = (0, exports.getFactors)();\r\n    const updatedFactors = [...existingFactors];\r\n    newFactors.forEach(newFactor => {\r\n        const exists = existingFactors.some(existingFactor => existingFactor.id === newFactor.id);\r\n        if (!exists) {\r\n            updatedFactors.push(newFactor);\r\n        }\r\n    });\r\n    (0, exports.saveFactors)(updatedFactors);\r\n};\r\nexports.updateFactors = updateFactors;\r\nconst saveSeasonFactors = (season, alphas) => {\r\n    return new Promise((resolve) => {\r\n        const data = {\r\n            season,\r\n            alphas,\r\n            lastUpdated: Date.now()\r\n        };\r\n        chrome.storage.local.set({ [season]: data }, () => {\r\n            resolve();\r\n        });\r\n    });\r\n};\r\nexports.saveSeasonFactors = saveSeasonFactors;\r\nconst getSeasonFactors = (season) => {\r\n    return new Promise((resolve) => {\r\n        chrome.storage.local.get([season], (result) => {\r\n            if (result[season]) {\r\n                resolve(result[season].alphas);\r\n            }\r\n            else {\r\n                resolve([]);\r\n            }\r\n        });\r\n    });\r\n};\r\nexports.getSeasonFactors = getSeasonFactors;\r\n// 兼容旧代码的通用方法\r\nconst saveToLocalStorage = (key, value) => {\r\n    return new Promise((resolve) => {\r\n        chrome.storage.local.set({ [key]: value }, resolve);\r\n    });\r\n};\r\nexports.saveToLocalStorage = saveToLocalStorage;\r\nconst getFromLocalStorage = (key) => {\r\n    return new Promise((resolve) => {\r\n        chrome.storage.local.get([key], (result) => resolve(result[key]));\r\n    });\r\n};\r\nexports.getFromLocalStorage = getFromLocalStorage;\r\n","\"use strict\";\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst storage_1 = require(\"../utils/storage\");\r\nconsole.log(\"WQB Alpha Manager Content Script Loaded\");\r\n// --- 延时函数 ---\r\nconst sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));\r\n// 辅助函数：提取表达式代码\r\nconst extractCode = (alphaObj) => {\r\n    if (alphaObj.code)\r\n        return alphaObj.code;\r\n    if (alphaObj.regular) {\r\n        if (typeof alphaObj.regular === 'string')\r\n            return alphaObj.regular;\r\n        if (alphaObj.regular.code)\r\n            return alphaObj.regular.code;\r\n    }\r\n    return \"无表达式\";\r\n};\r\nchrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\r\n    if (request.action === \"fetch_and_save\") {\r\n        const startDate = request.startDate;\r\n        const endDate = request.endDate;\r\n        const season = request.season;\r\n        console.log(`[WQB Manager] 开始抓取: ${season} (${startDate} ~ ${endDate})`);\r\n        const fetchAllAlphas = () => __awaiter(void 0, void 0, void 0, function* () {\r\n            let allAlphas = [];\r\n            let offset = 0;\r\n            const limit = 100;\r\n            let hasMore = true;\r\n            const dateStartParam = `${startDate}T00:00:00-04:00`;\r\n            const encodedStart = encodeURIComponent(dateStartParam);\r\n            const encodedEnd = encodeURIComponent(`${endDate}T23:59:59-04:00`);\r\n            while (hasMore) {\r\n                const apiUrl = `https://api.worldquantbrain.com/users/self/alphas?limit=${limit}&offset=${offset}&status!=UNSUBMITTED&type=REGULAR&dateCreated>=${encodedStart}&dateCreated<=${encodedEnd}`;\r\n                try {\r\n                    console.log(`[WQB Manager] Fetching offset ${offset}...`);\r\n                    // --- 修改点 1: 增加延时到 3秒 (3000ms) ---\r\n                    if (offset > 0) {\r\n                        yield sleep(3000);\r\n                    }\r\n                    // --- 修改点 2: 增加 credentials: 'include' ---\r\n                    // 这确保请求会带上你在 WQ 网站登录后的 Cookie\r\n                    const response = yield fetch(apiUrl, {\r\n                        method: 'GET',\r\n                        headers: {\r\n                            'Content-Type': 'application/json'\r\n                            // 通常不需要手动加 Authorization header，因为 Cookie 会自动处理\r\n                        },\r\n                        credentials: 'include'\r\n                    });\r\n                    if (!response.ok) {\r\n                        if (response.status === 429) {\r\n                            throw new Error(\"请求太快被限制了(429)，请等待几分钟后再试。\");\r\n                        }\r\n                        if (response.status === 401 || response.status === 403) {\r\n                            throw new Error(\"未登录或登录过期(401/403)。请在浏览器中重新登录 WQ 官网并刷新页面。\");\r\n                        }\r\n                        throw new Error(`HTTP error! status: ${response.status}`);\r\n                    }\r\n                    const data = yield response.json();\r\n                    const results = data.results || [];\r\n                    const count = data.count || 0;\r\n                    if (results.length === 0) {\r\n                        hasMore = false;\r\n                        break;\r\n                    }\r\n                    const pageAlphas = results.map((item) => {\r\n                        var _a;\r\n                        return ({\r\n                            id: item.id,\r\n                            code: extractCode(item),\r\n                            dateCreated: item.dateCreated,\r\n                            author: \"Me\",\r\n                            region: ((_a = item.settings) === null || _a === void 0 ? void 0 : _a.region) || \"UNKNOWN\"\r\n                        });\r\n                    });\r\n                    allAlphas = allAlphas.concat(pageAlphas);\r\n                    offset += limit;\r\n                    if (offset >= count) {\r\n                        hasMore = false;\r\n                    }\r\n                    if (allAlphas.length > 20000) {\r\n                        console.warn(\"达到 20000 条限制，停止抓取\");\r\n                        hasMore = false;\r\n                    }\r\n                }\r\n                catch (error) {\r\n                    console.error(\"[WQB Manager] 抓取出错:\", error);\r\n                    throw error;\r\n                }\r\n            }\r\n            return allAlphas;\r\n        });\r\n        fetchAllAlphas()\r\n            .then(alphas => {\r\n            console.log(`[WQB Manager] 抓取完成，共 ${alphas.length} 条`);\r\n            return (0, storage_1.saveSeasonFactors)(season, alphas).then(() => alphas.length);\r\n        })\r\n            .then((count) => {\r\n            sendResponse({ msg: `成功下载 ${count} 个因子到 ${season}` });\r\n        })\r\n            .catch(error => {\r\n            sendResponse({ msg: `抓取失败: ${error.message}` });\r\n        });\r\n        return true;\r\n    }\r\n    if (request.action === \"match_field\") {\r\n        return true;\r\n    }\r\n});\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(7618);\n"],"names":["Object","defineProperty","exports","value","getFromLocalStorage","saveToLocalStorage","getSeasonFactors","saveSeasonFactors","updateFactors","getFactors","saveFactors","STORAGE_KEY","factors","localStorage","setItem","JSON","stringify","getItem","parse","newFactors","existingFactors","updatedFactors","forEach","newFactor","some","existingFactor","id","push","season","alphas","Promise","resolve","data","lastUpdated","Date","now","chrome","storage","local","set","get","result","key","__awaiter","this","thisArg","_arguments","P","generator","reject","fulfilled","step","next","e","rejected","done","then","apply","storage_1","console","log","sleep","ms","setTimeout","extractCode","alphaObj","code","regular","runtime","onMessage","addListener","request","sender","sendResponse","action","startDate","endDate","allAlphas","offset","hasMore","encodedStart","encodeURIComponent","encodedEnd","apiUrl","response","fetch","method","headers","credentials","ok","status","Error","json","results","count","length","pageAlphas","map","item","_a","dateCreated","author","region","settings","concat","warn","error","msg","catch","message","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","module","__webpack_modules__","call"],"ignoreList":[],"sourceRoot":""}